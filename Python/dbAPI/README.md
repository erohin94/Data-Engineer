# **dbAPI**

**dbAPI (Database API)** — это стандартный интерфейс, предназначенный для работы с базами данных в языке Python. 
Он обеспечивает универсальный подход к взаимодействию с различными СУБД (системами управления базами данных), скрывая различия между ними.

Ключевые компоненты DBAPI:

dbAPI описывает несколько объектов и методов, которые являются частью взаимодействия с базами данных:

**Connection** — объект для установления и управления соединением с базой данных.

Метод `connect()` — для установления соединения с базой данных.

Атрибуты:

`autocommit` — включает или выключает автоматическое подтверждение транзакций.

`commit()` — подтверждение изменений в базе данных.

`rollback()` — откат транзакций.

**Cursor** — объект для выполнения SQL-запросов, извлечения данных и управления результатами запросов.

Метод `cursor()` — создаёт объект курсора для выполнения запросов.

Основные методы курсора:

`execute(query, parameters)` — выполнение SQL-запроса с параметрами.

`fetchall()` — извлечение всех строк результата запроса.

`fetchone()` — извлечение одной строки результата.

`fetchmany(size)` — извлечение нескольких строк.

**Exceptions** — стандартные классы исключений для обработки ошибок, связанных с базой данных.

Исключения, поддерживаемые dbAPI:

`DatabaseError` — общая ошибка базы данных.

`IntegrityError` — ошибка, связанная с нарушением целостности данных.

`OperationalError` — ошибка, возникающая при проблемах с подключением или запросами.

`ProgrammingError` — ошибка, связанная с синтаксисом SQL-запроса.

**Transactions** — стандартный способ управления транзакциями, поддержка коммитов (commit) и откатов (rollback).

Пример использования DBAPI с SQLite:

```
import sqlite3

# Установление соединения с базой данных
connection = sqlite3.connect('example.db')

# Создание курсора для выполнения запросов
cursor = connection.cursor()

# Выполнение SQL-запроса
cursor.execute('SELECT * FROM employees')

# Извлечение всех строк результата
results = cursor.fetchall()

# Закрытие соединения с базой данных
connection.close()
```

# `Impala.dbapi`

## Содержание

 - [Описание Impala.dbapi](#title)
 - [Подключение dbapi.connect](#title2)
 - [cursor](#cursor)
 - [Примеры](#Примеры)

### <a id="title">Описание Impala.dbapi<a/>
```Impala.dbapi``` представляет собой библиотеку для подключения и взаимодействия с Apache Impala (ранее известной как Cloudera Impala) с использованием Python. Apache Impala является распределенной системой аналитической обработки данных, предназначенной для выполнения SQL-запросов в режиме реального времени на больших объемах данных.

```Impala.dbapi``` обеспечивает простой и удобный способ подключиться и взаимодействовать с Impala из Python. Он реализует стандартный интерфейс Python DB-API 2.0, что позволяет использовать знакомые методы и синтаксис при работе с данными.

Вы сможете импортировать ```impala.dbapi``` и создать подключение к ```Impala```. Вот пример кода:

```python
import impala.dbapi as dbapi

# Создание подключения к Impala
conn = dbapi.connect(host='имя_хоста', port=имя_порта, database='имя_базы_данных')

# Создание курсора
cursor = conn.cursor()

# Выполнение SQL-запроса
cursor.execute('SELECT * FROM имя_таблицы')

# Получение результатов
results = cursor.fetchall()

# Вывод результатов
for row in results:
print(row)

# Закрытие курсора и соединения
cursor.close()
conn.close()
```

В этом примере мы создаем подключение к Impala, создаем курсор, выполняем SQL-запрос на выборку данных из таблицы и выводим результаты. По завершении работы следует закрыть курсор и соединение для корректного освобождения ресурсов.

```Impala.dbapi``` также поддерживает параметризованные запросы, аутентификацию Kerberos и другие функции, которые можно использовать для более продвинутой работы с Impala.

В целом, ```impala.dbapi``` предоставляет удобный способ взаимодействия с Impala из Python, позволяя выполнять SQL-запросы и обрабатывать полученные результаты.

### <a id="title2">Подключение dbapi.connect<a/>
Как мы видели ранее строка ниже создает подключение к импала:
```python
conn = dbapi.connect(host='имя_хоста', port=имя_порта, database='имя_базы_данных')
```
Давайте рассмотрим все методы которые можно использовать с ```connect```.
```python
conn.cursor()
conn.commit()
conn.close()
```

```cursor``` - создает новый объект "курсор", используется для выполнения команд к БД<br>
```commit``` - закомичивает изменения в БД, в импале не используется. Нужен для работы с такими БД как MS-SQL server<br>
```close``` - закрытие подключения. Необходимо выполнять после завершения работы с БД. <br>

### cursor
Метод cursor используется для выполнения команд к БД.<br>
```cursor.execute(operation [, parameters])``` - выполняет команду к БД, в opertion может быть как запрос, так и команда. <br>
```cursor.fetchall() ``` - Возвращает все строки из результата запроса в виде списка кортежей строк.<br>
```cursor.fetchone() ``` - Возвращает следующую строку из результата запроса в виде кортежа. Если в результате больше нет строк, возвращает None.<br>
```cursor.fetchmany(size=cursor.arraysize) ``` - Возвращает заданное количество строк из результата запроса. По умолчанию возвращает все строки. Возвращает список кортежей строк.<br>
```cursor.arraysize ```- Определяет количество строк, которое будет возвращено методом fetchmany(). По умолчанию равно 1.<br>
```cursor.scroll(n) ``` - Не работает с Импала, в других БД перемещает курсор на заданное количество строк в результате запроса. Положительное значение перемещает курсор вперед, отрицательное - назад.<br>
```cursor.rowcount ``` - Возвращает количество строк, затронутых последней операцией выполнения запроса. Атрибут имеет значение -1 в случае, если над курсором не было выполнено .execute*() или количество строк последней операции не может быть определено интерфейсом<br>
```cursor.description ``` - Возвращает информацию о столбцах в результате запроса в виде списка кортежей. Каждый кортеж содержит информацию о столбце, такую как имя, тип данных и т.д.<br>
```cursor.executemany(operation, seq_of_parameters) ``` - многократно выполняет команды/запросы к БД с применением всех параметров предоставленных в последовательности seq_of_parameters <br>
```cursor.close() ``` - закрыть курсор. Выполняется когда более не требуется выполнять запросы к БД. <br>

### Примеры
Далее разберем на примерах работы выше описанных методов<br><br>
Блок импортов для выполнения дальнейших примеров

```
import os
import getpass
import traceback
import pandas as pd
from impala.dbapi import connect
```

Создаем функцию для подключения используя коннект из impala.dbapi

```
def impala_connect():
    return connect(host='hdp-y9ret',
                   port=11111,
                   use_ssl='true',
                   auth_mechanism='GSSAPI') # Механизм аутентификации Kerberos

# Если обычная аутентификация
conn = connect(host='hdp-y9ret', port=11111, user='user_name', password = 'pass')
```

Следующий блок необходим для получения тикета доступа, запустите его, введите пароль и нажмите клавишу Enter

```
# Получение логина и указание пароля
login = getpass.getuser()
print('Введите пароль')
password = getpass.getpass()

# Получение тикета доступа для подключения к БД
os.system('echo ' + password + ' | kinit ' + login)
!klist
```

Создание подключения conn и курсора cursor

```
conn = impala_connect()
cursor = conn.cursor()
```

Задаем sql запрос с сортировкой на календарь от самой старой даты и получаем первые 65 дней

```
sql = 'select * from dm_evd.xref_calendar order by calendar_dt limit 65'
```

Если есть необходимость задать конфигурацию запроса, например изменить лимит памяти на выполняемый запрос, это можно сделать с помощью ```configuration``` в примере ниже

```
cursor.execute(sql, configuration={'mem_limit': '3gb'})
```

Конструкция ```try-except``` необходима для безопасности кода, через ```traceback``` мы получаем ошибку от импалы

```
try:
    cursor.execute(sql)
except:
    error = traceback.format_exc()
    print(error)
else:
    df_result = pd.DataFrame(cursor.fetchall())
```

Вывод получаемого датафрейма, с нумерацией вместо названий столбцов из БД, может быть полезно если имена столбцов не имеют ценности

```
df_result.head()
```

Вывод получаемого датафрейма, с названиями столбцов из БД, может быть полезно если имена столбцов необходимы для дальнейшей работы с данными

```
cursor.execute(sql)
new_df = pd.DataFrame(cursor.fetchall(), columns = [desc[0] for desc in cursor.description])
new_df.head()
```

Пример работы ```fetchone```, при вызове данного метода мы получаем 1 строку данных, начиная с первой в виде кортежа с данными. при повторном вызове получаем 2ю строку и т.д.

```
cursor.execute(sql)
one = cursor.fetchone()
two = cursor.fetchone()
print(one)
print(two)
```

Пример работы ```fetchmany```. В скобках мы укуазали кол-во строк необходимых для вывода. получили список кортежей с данными по строчно.

```
cursor.execute(sql)
newer = cursor.fetchmany(3)
print(newer)
```

Пример работы ```rowcount```, к сожалению на текущих параметрах система не смогла определить кол-во строк получаемых запросом

```
cursor.execute(sql)
a = cursor.rowcount
a
```

Пример работы description для получения "описания данных"

```
cursor.description
```

Закрытие курсора и закрытие подключения

```
cursor.close()
conn.close()
```
