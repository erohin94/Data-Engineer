# Идемпотентность в Airflow 

**Идемпотентность** — это когда повторный запуск задачи даёт тот же результат, что и первый. Запусти task 1, 5 или 100 раз — итог не меняется.

Airflow часто перезапускает task-и (retry, backfill, clear), поэтому задачи должны быть безопасными при повторном выполнении.

Чтобы не было: дублей, испорченных/частичных данных, расхождений между витринами, некорректных пересчётов при backfill

**Как сделать task идемпотентным?**

1. Использовать `data_interval`

Работать за конкретную дату/час, а не текущий момент (`now()`).

Использовать:

```
{{ data_interval_start }}
{{ data_interval_end }}
{{ ds }}
```

2. Перезаписывать результат, а не добавлять

Плохо: `INSERT` каждый раз → дубли

Хорошо: `DELETE → INSERT` или `MERGE` за конкретный интервал

3. Атомарная запись

Сначала временная таблица / temp-файл → затем замена финального результата.

4. Чёткая граница интервала

Обрабатывай только данные за:

1 дату

1 час

15 минут

текущий data_interval

Пример идемпотентного паттерна (DELETE + INSERT)

```
-- 1. Создание временной таблицы за дату
CREATE TABLE stg.tmp_target_{{ ds }} AS
SELECT *
FROM source_table
WHERE date = '{{ ds }}';

-- 2. Удаление старых данных в целевой таблице
DELETE FROM dm.target_table
WHERE date IN (SELECT date FROM stg.tmp_target_{{ ds }});

-- 3. Вставка актуальных данных
INSERT INTO dm.target_table
SELECT * FROM stg.tmp_target_{{ ds }};
```

Повторный запуск даст тот же результат. Нет дублей. Нет порчи данных.

Самое краткое определение

Идемпотентность в Airflow = задача может выполниться много раз, но итог всегда один и тот же.
Это достигается тем, что мы перезаписываем данные за конкретный интервал, а не добавляем новые.

[Пример проекта с идемпотентностью](https://github.com/erohin94/pet_project_earthquake/blob/main/step.md)
